<script type="text/javascript">
function mySubmitform(frm) 
{
	// assign our form to object f
	//var f = document.forms.form_a;
	frm.submit();
}
</script>
<?php if(isset($_GET['t']))
	  {
			$lbid = $_GET['t'];			
			if($lbid==0)
				$lbidnew=1;
			if($lbid==1)
				$lbidnew=2;
			if($lbid==3)
				$lbidnew=3;
	  }
	  else
		 $lbidnew=1;
?>			
<script type="text/javascript" >
	$(document).ready(function()
	{		
		$("div#statusbutton").mouseover(
			function()
			{
				$(this).css({'color':'#000000', 'font-weight':'bolder'});
			});
		
		$("div#statusbutton").mouseout(
			function()
			{
				$(this).css({'color':'#000000', 'font-weight':'normal'});
			});
		$("div#button").mouseover(
			function()
			{
				$(this).css({'color':'#000000', 'font-weight':'bolder'});
			});
		$("div#button").mouseout(
			function()
			{
				$(this).css({'color':'#000000', 'font-weight':'normal'});
			});
		$("td#lbutton1").mouseover(
			function()
			{
				$(this).css({'color':'red', 'font-weight':'bolder'});

			});
		$("td#lbutton1").mouseout(
			function()
			{	
				<?php if($lbidnew !=1) {?>
				$(this).css({'color':'#fffffc', 'font-weight':'normal'});
				<?php }?>
			});
		$("td#lbutton2").mouseover(
			function()
			{
				$(this).css({'color':'red', 'font-weight':'bolder'});
			});
		$("td#lbutton2").mouseout(
			function()
			{
				<?php if($lbidnew !=2) {?>
				$(this).css({'color':'#fffffc', 'font-weight':'normal'});
				<?php }?>				
			});
		$("td#lbutton3").mouseover(
			function()
			{
				$(this).css({'color':'red', 'font-weight':'bolder'});
			});
		$("td#lbutton3").mouseout(
			function()
			{
				<?php if($lbidnew !=3) {?>
				$(this).css({'color':'#fffffc', 'font-weight':'normal'});
				<?php }?>
			});			
			$("td#lbutton<?php echo $lbidnew ?>").css({'color':'red', 'font-weight':'bolder'});
	})
</script>
<?php
	include_once("library/session.php");
	include_once("./editables/loaners.php");
    /*    Process loans that have expired    */	

    $session->processOldLoans();
	$ltext="index.php?p=14&u=";
	$sp=0;
	$ud=0;
	$t=0;

	if(isset($_GET['s'])){
		$sp=$_GET['s'];
    }
	
	if(isset($_GET['u'])){
		$ud=$_GET['u'];
    }
	
	if(isset($_GET['t'])){
		$t=$_GET['t'];
    }

	if($sp==0){
		$noOfopenloans=$database->getOpenBorrowers(0 , 0,$t);
		//echo $noOfopenloans;
		$st=0;
		$start=0;
		$end=0;
		$c=50;

		if(isset($_REQUEST['c'])){
			$c = intval($_REQUEST['c']);
        }
		if(isset($_REQUEST['n'])){
			$st = intval($_REQUEST['n'])+$c;
        }

		$st1=$st+$c;
		
		if($st1 >= $noOfopenloans){
			$end=1;
        }
		if(isset($_REQUEST['f'])){
			$st = intval($_REQUEST['f'])-$c;
        }
		if($st<=0){
			$st=0;$start=1;
        }

		//echo $st;
		$openloans=$database->getOpenBorrowers($st , $c,$t);

		if( !isset($_GET['t']))
		{
			if($database->flag==1)
			$t=8;
		}

		//Change by Pranjal 5/19/2010 to allow adding of email ids

        if($t == 8 && !isset($_GET['t']))
		{
            echo $lang['loaners']['newtext'];
          ?>
			<br/><br/><br/>
            <form method="post" action="updateprocess.php">
				<table>
          <?php		if(isset ($_GET['r']) && $_GET['r'] ==1)
					{	?>
						<tr bgcolor="#A3D84D">
						<td colspan="10"><?php  echo $lang['loaners']['successtext']; ?></td>
						</tr>
          <?php		}	?>                    
	                <tr>
						<td width="80"> </td>
						<td></td>
						<td><?php echo $form->error("email") ?></td>
						<td></td>
            		</tr>
					<tr>
						<td width="80"> </td>
						<td><?php echo 'Email:' ;?></td>
						<td>
							<input type="text" maxlength="20" name="email" class="inputcmmn-1" value="<?php echo $form->value("email"); ?>" />     <input type="submit" value="Submit" />
						</td>
						<td><input type="hidden" name="emailregister" /></td>
            		</tr>
				</table>
            </form>
			<br/><br/><br/>        
<?php	}
		else
		{
			if($session->userlevel != LENDER_LEVEL)
			{
				$ltext="index.php?p=1";
                echo "<div>".$lang['loaners']['please_reg']."<a href=$ltext>".$lang['loaners']['reg']."</a></div><br />";
            }
		}
		echo "<table border='0' width='100%'>";
		$setcolor=0;
?>
		<tr>
			<td width ="100%">
				<table width ="100%">
					<tr >
						<form action='index.php' method='get' id='form_a' name='form_a'> 
						<td id="lbutton1" class="lend-button" ><a href="#" onClick="javascript:mySubmitform(form_a);" style="text-decoration:none;color:black"><?php echo $lang['loaners']['fund_loans'];?></a></td>							
					<?php
							echo"<input type='hidden' name='t' value=0 />";
							echo"<input type='hidden' name='p' value=2 />";
							echo"<input type='hidden' name='c' value=$c />";
							echo"<input type='hidden' name='st' value=$st />";	
							//echo"<input type='submit' name='go' value='Show' />";
						echo"</form>";
					?>
						<form action='index.php' method='get' id='form_b' name='form_b'> 
						<td id="lbutton2" class="lend-button" ><a href="#" onClick="javascript:mySubmitform(form_b);" style="text-decoration:none;color:black"><?php echo $lang['loaners']['act_loans'];?></a></td>							
					<?php
							echo"<input type='hidden' name='t' value=1 />";
							echo"<input type='hidden' name='p' value=2 />";
							echo"<input type='hidden' name='c' value=$c />";
							echo"<input type='hidden' name='st' value=$st />";	
							//echo"<input type='submit' name='go' value='Show' />";
						echo"</form>";
					?>
						<form action='index.php' method='get' id='form_c' name='form_c'> 
						<td id="lbutton3" class="lend-button" ><a href="#" onClick="javascript:mySubmitform(form_c);" style="text-decoration:none;color:black"><?php echo $lang['loaners']['end_loans'];?></a></td>							
					<?php
							echo"<input type='hidden' name='t' value=3 />";
							echo"<input type='hidden' name='p' value=2 />";
							echo"<input type='hidden' name='c' value=$c />";
							echo"<input type='hidden' name='st' value=$st />";
							//echo"<input type='submit' name='go' value='Show' />";
						echo"</form>";
		echo'</tr></table></td></tr>';

		//echo '<tr><td><table border=0 width="100%" height="25" cellspacing="2"><tr><td width=32% bgcolor="#fff55c"><b>&nbsp;&nbsp;<font color=#000000></font></b></td><td width=20% bgcolor="#fff55c"><b>&nbsp;&nbsp;<font color=#000000>'.$lang['loaners']['nameadd'].'</font></b></td><td width=20% bgcolor="#fff55c"><b>&nbsp;&nbsp;<font color=#000000>'.$lang['loaners']['loand'].'</font></b></td><td bgcolor="#fff55c"><b>&nbsp;&nbsp;<font color=#000000>'.$lang['loaners']['loanU'].'</font></b></td></tr></table></td></tr>';

		$button='button';
		$buttontext='Lend';
		if($t >=1)
		{
			$button='statusbutton';
			$buttontext='Status';
		}
		if(!empty($openloans))
		{
			foreach($openloans as $row)
			{
				$userid=$row['userid'];
				$name=$row['FirstName'].' '.$row['LastName'];
				$post=$row['PAddress'];
				$city=$row['City'];
				$country=$database->mysetCountry($row['Country']);
				$amount=$row['reqdamt'];
				//$interest=$row['interest'];
	            $period=$row['period'];
				$grace=$row['grace'];		
				if($row['tr_loanuse']==null || $row['tr_loanuse']=="")
					$loanuse=$row['loanuse'];
				else
					$loanuse=$row['tr_loanuse'];				
				$photo=$row['Photo'];
				$loanid = $row['loanid'];
				$interest=$database->getAvgBidInterest($userid, $loanid);
				$totBid=$database->getTotalBid($borrowerid,$loanid);
				$brw2 = $database->getLoanDetails($loanid);
				$ramount=number_format($brw2['reqdamt'], 0, "", "");
				
				if($totBid>=$ramount)
				{
					//$interest=$interest;
				}
				else
				{
					$brw2 = $database->getLoanDetails($loanid);
					$webfee=$brw2['WebFee'];
					$interest=$brw2['interest'] - $webfee;
				}
				//$loanuse=$session->smart_trim($loanuse, 100);
				$report=$database->loanReport($userid);
				$f=$report['feedback'];
				$cf=$report['Totalfeedback'];
				
				if(!$photo || $photo==NULL)
				{
					$photo='library/getimage.php?id='.$userid.'&width=300&height=400';
				}
				$statusbar=$session->getStatusBar($userid,$loanid);
				$amount=number_format($amount, 0, ".", ",");
				
				if($setcolor==0)
				{
					echo '<tr><td>';
					echo '<div style="width:100%">';
					echo '<table class="lendertable" cellspacing="3">';
					echo '<tr >';
					echo "<td width='50%' valign='top'><a href='index.php?p=14&u=$userid&l=$loanid' margin-left='5'><img src=$photo style='border:#cccccc 1px ridge' /></a></td>";
					echo "<td width='50%' valign='top'><div style='margin-left:5px'><a href='index.php?p=14&u=$userid&l=$loanid'>$name</a><br />". number_format($f, 2, '.', ',')." % Positive (<a href='index.php?p=12&u=$userid&fdb=2'>".$cf."</a>)<br />$city, $country<br /><br />";
					if(strlen($loanuse) >200)
								echo substr($loanuse,0,200).".... <a href='index.php?p=14&u=$userid&l=$loanid'>(read more)</a>";
					else
					echo $loanuse;
					echo "</div><br /><div id='".$button."' style='margin-left:50px;'><a href='index.php?p=14&u=$userid&l=$loanid#e5' style='text-decoration:none;color:black'>".$buttontext."</a></div><br /><div style='margin-left:5px'><b>Amount Requested:</b> $amount USD<br /><b>Interest:</b>". " ".number_format($interest, 2, '.', ',')."%<br /><br /><table width=80%><tr> <td>$statusbar </td> </tr></table> </div></td>";		

					//echo "<td width='110'  valign='top'><div style='margin-left:5px'><b>Amount:</b> $amount USD<br /><b>Interest:</b>". " ".number_format($interest, 2, '.', ',')."%<br /><b>Repayment Period:</b> $period Months<br /><b>Grace Period:</b> $grace Months<br /><br /><br />$statusbar</div></td>";
					//echo "<div><a href='index.php?p=14&u=$userid&l=$loanid#e5'><div id='".$button."' align='center'>Status</div></a></div></td>";
					//echo "<div><div id='".$button."' align='center'><a href='index.php?p=14&u=$userid&l=$loanid#e5' style='text-decoration:none;color:black'>".$buttontext."</a></div></div></td>";
					echo '</tr>';
					echo '</table>';
					echo '</div>';
					echo '</td></tr>';
					$setcolor=1;
				}
				else
				{
					echo '<tr><td>';
					echo '<div style="width:100%">';
					echo '<table class="lendertable_o" cellspacing="3">';
					echo '<tr >';
					echo "<td width='50%'><a href='index.php?p=14&u=$userid&l=$loanid' margin-left='5'><img src=$photo style='border:#cccccc 1px ridge' /></a></td>";
					echo "<td width='50%' valign='top'><div style='margin-left:5px'><a href='index.php?p=14&u=$userid&l=$loanid'>$name</a><br />". number_format($f, 2, '.', ',')." % Positive (<a href='index.php?p=12&u=$userid&fdb=2'>".$cf."</a>)<br />$city,$country<br /><br />$loanuse</div><br /><div><a href='index.php?p=14&u=$userid&l=$loanid#e5'><div id='".$button."' style='margin-left:50px;'>".$buttontext."</div></a></div><br /><div style='margin-left:5px'><b>Amount Requested:</b> $amount USD<br /><b>Interest:</b>". " ".number_format($interest, 2, '.', ',')."%<br /><br /><table width=80%><tr> <td>$statusbar </td> </tr></table></div></td>";	

						//echo "<td width='110'  valign='top'><div style='margin-left:5px'><b>Amount:</b> $amount USD<br /><b>Interest:</b>". number_format($interest, 2, '.', ',')."%<br /><b>Repayment Period:</b> $period Months<br /><b>Grace Period:</b> $grace Months<br /><br /><br />$statusbar</div></td>";
						//echo "<td width='160'  valign='top'><div style='height:75px; margin-left:5px; width:100%'>$loanuse</div>";
					//echo "<div><a href='index.php?p=14&u=$userid&l=$loanid#e5'><div id='".$button."' align='center'>pppp</div></a></div></td>";
					//echo "<div><a href='index.php?p=14&u=$userid&l=$loanid#e5' style='text-decoration:none;color:black'><div id='".$button."' align='center'>".$buttontext."</div></a></div></td>";

					echo '</tr>';
					echo '</table>';
					echo '</div>';
					echo '</td></tr>';
					$setcolor=0;
				}
			}
			
			echo "<tr><td><div align='right' id='next_page'>";
			if(!$start)
			{
				echo "<a href='index.php?p=2&f=$st&c=$c'>".$lang['loaners']['Previous']."</a>";
			}
			echo"&nbsp;&nbsp;";
			if(!$end)
			{
				echo"<a href='index.php?p=2&n=$st&c=$c'>".$lang['loaners']['Next']."</a>";
			}
			echo"</div></td></tr>";
		}
		else
		{
			echo" <tr><td>No data for this selection</td></tr>";
		}
		echo "</table>";
	}

	if($sp==1)
	{
		if($ud==0)
		{
			echo $lang['loaners']['invalidsec'];
		}
		else
		{
			$brw=$database->getOpenBorrower($ud);
			$loanid=$brw['loanid'];
			$name=$brw['FirstName'].' '.$brw['LastName'];
			$post=$brw['PAddress'];
			$location=$brw['City'].', '.$brw['Country'];
			$tel=$brw['TelMobile'];
			$email=$brw['Email'];
			$income=$brw['AnnualIncome'];			
			$loanuse=$brw['loanuse'];			
			if($brw['tr_BizDesc']==null)
				$biz=$brw['BizDesc'];
			else
				$biz=$brw['tr_BizDesc'];
			if($brw['tr_About'])
				$about=$brw['About'];
			else
				$about=$brw['tr_About'];
			$interest=$brw['interest'];
			$period=$brw['period'];
			$dincome=$income/$database->getCurrentRate($ud);
			$lamount=$brw['Amount'];
			$damount=$lamount/$database->getCurrentRate($ud);
			$lamount=number_format($lamount, 2, ".", ",");
			$income=number_format($income, 2, ".", ",");
			$interest1=number_format($interest, 2, ".", ",");
			$dincome=number_format($dincome, 2, ".", ",");
			$damount=number_format($damount, 2, ".", ",");
			$partner=$database->getBorrowerPartner($ud);//user's partner detail
			$partid=$partner['userid'];
			$partname=$partner['name'];
			$partwebsite=$partner['website'];
	?>
			<script type="text/javascript" src="includes/scripts/submain.js"></script>
			<table style="width:100%">
				<tr>
					<td>
						<div style="width:90%; border:#cccccc 1px solid; padding:5px">
			<?php
						echo "<table width='100%'><tr><td><div style='padding:5px; height:30px'><a href='index.php?p=12&u=$ud'><b>$name</b></a><br /></div><br /><div style='width:95%; padding:5px'><i>".$lang['loaners']['Address']."</i><br>$post<br />$location<br />".$lang['loaners']['Telephone']." $tel<br />".$lang['loaners']['email']." $email</div></td><td><div align='center'><img src='library/getimage.php?id=$ud&width=120&height=120'/></div></td></tr></table>"; 
						echo "<div style='padding:5px'>";
						echo "".$lang['loaners']['aincome']." Kshs. $income (USD. $dincome)<br />";
						echo "".$lang['loaners']['loanamt']." Kshs. $lamount (USD $damount)<br />";
						echo "".$lang['loaners']['Period']." $period months<br />";
						echo "".$lang['loaners']['loan_int']." $interest1 %";
						echo "</div>";
						echo "<div style='padding:5px'>";
						echo "<i>".$lang['loaners']['ploan']."</i><br>";
						echo "$loanuse";
						echo "</div>";
						echo "<div style='padding:5px'><i>".$lang['loaners']['bdiscription']."</i><br>";
						echo "$biz";
						echo "</div>";
						echo "<div style='padding:5px'><i>".$lang['loaners']['About']." $name</i><br>";
						echo "$about";
						echo "</div>";
						echo "<div style='padding:5px'><i>".$lang['loaners']['Patrner']."<a href='index.php?p=12&u=$partid'><b> $partname</b></a></i><br>";
						echo "<a href='http://$partwebsite'>$partwebsite</a>";
						echo "</div>";
						$bids=$database->getLoanBids($ud, $loanid);
						$interestrate=number_format($database->getAvgBidInterest($ud), 2, '.', ',');
						
						if(empty($bids))
						{
							echo $lang['loaners']['no_bid_for_u'];
						}
						else
						{
							echo "<table style='width:95%' border='0'>";
							echo "<tr><td colspan='4'>";
							echo "".$lang['loaners']['tamt_bid']." USD. " .number_format($database->getTotalBid($ud), 2, '.', ',')." <br />";
							echo "".$lang['loaners']['tamt_bid']." Kshs. " .number_format((($database->getTotalBid($ud))*($database->getCurrentRate($ud))), 2, '.', ',')." <br />";
							echo "".$lang['loaners']['avr_int_r']." $interestrate %<br />";
							echo "".$lang['loaners']['reqamt']." ".$database->getOpenLoanAmount($ud).' (USD. '.($database->getOpenLoanAmount($ud)/$database->getCurrentRate($ud)).")";
							$p=((($database->getTotalBid($ud)*($database->getCurrentRate($ud))))/($database->getOpenLoanAmount($ud)))*100 ;
							$p=number_format($p, 3, ".", ",");
							echo "<br />".$lang['loaners']['rpercentage']." ".$p."%";
							echo "</td></tr>";
							echo "<tr><td colspan='4'>".$lang['loaners']['status']."";
							echo "<table border='0' width='50%' cellspacing='0' cellpading='0' style='; height:10px; border:#006600 1px solid'><tr><td width='$p%' bgcolor='#006600'></td><td></td></tr></table>";
							echo "</td></tr>";
							echo "<tr><td colspan='4'><table border='0' width='100%' cellspacing='0'cellpadding='0' style='; height:10px; border:#006600 1px solid'><tr><th>".$lang['loaners']['lname']."</th><th>".$lang['loaners']['bidamt']."(USD)</th><th>".$lang['loaners']['bidamt']."(KSH)</th><th>".$lang['loaners']['bidint']."</th></tr>";

							foreach($bids as $rows )
							{
								$lendid=$rows['lenderid'];
								$lname=$rows["Firstname"].' '.$rows['LastName'];
								$bidamount=$rows['bidamount'];
								$kamount=$bidamount*$database->getCurrentRate($ud);
								$bidint=$rows['bidint'];
								$bidamount=number_format($bidamount, 2, ".",",");
								$kamount=number_format($kamount, 2, ".",",");
								$bidint=number_format($bidint, 2, ".",",");
								echo "<tr>";
								echo "<td style='text-align:center'><a href='index.php?p=12&u=$lendid'>$lname</a></td>";
								echo "<td style='text-align:center'>$bidamount</td>";
								echo "<td style='text-align:center'>$kamount</td>";
								echo "<td style='text-align:center'>$bidint %</td>";
								echo "</tr>";
							}
							
							echo "</table</td></tr>";
							echo "</table>";
						}	?>
						
						<div style="padding:5px">
							<form action="process.php" method="post">
								<?php echo $lang['loaners']['perferred_amt'];?>&nbsp; 
								<?php echo $database->getAdminSetting('minBorrowerAmt');?>.<br/> 
								<?php echo $lang['loaners']['preferred_int_rate'];?>
								<?php
									if(($interestrate!=0.00))
									{
										echo $interestrate." %<br />";
									}
									else
									{
										echo $interest1." %<br />";
									}	?>
									<br />
									<table>
										<tr>
											<td><label for="pamount"><?php echo $lang['loaners']['bidamt'];?> (USD) </label></td>						<td><input type="text" maxlength="6" id="pamount" name="pamount" value="<?php $form->value('pamount'); ?>" /></td>
											<td><div id="pamounterr"><?php echo $form->error('pamount'); ?></div></td>
										</tr>
										<tr>
											<td><label for="pinterest"><?php echo $lang['loaners']['bidint'];?></label></td>
											<td><input type="text" maxlength="6" name="pinterest" value="<?php $form->value('pinterest'); ?>" /></td>
											<td><div id="pinterest"><?php echo $form->error('pinterest'); ?></div></td>
										</tr>
										<tr>
											<td colspan="2" align="right">
												<input type="hidden" name="lenderbid" />
												<input type="hidden" name="bid" value="<?php echo $ud ?>" />
												<input type="hidden" name="lid" value="<?php echo $loanid ?>" />
												<input type="submit" value="<?php echo $lang['loaners']['bid'];?>" />
											</td>
											<td></td>
										</tr>
									</table>
								</form>
							</div>
						</div>
					</td>
				</tr>
			</table>
<?php	}
	}

	if($sp==2)
	{	?>
		<table>
			<tr>
				<td><?php echo $lang['loaners']['bid_continue'];?><br><br></td>
			</tr>
			<tr>
				<td>
					<?php echo $lang['loaners']['valid_till'];?><br>
					<?php echo $lang['loaners']['amt_by'];?><br><br>
					<?php echo $lang['loaners']['Webmaster'];?>
					<a href="index.php?p=2"><?php echo $lang['loaners']['Blender_list'];?></a>
				</td>
			</tr>
		</table>
<?php
	}
?>